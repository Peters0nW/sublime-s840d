%YAML 1.2
# The MIT License (MIT)
#
# Copyright (c) 2016 DeathAxe <deathaxe82@googlemail.com>
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to
# deal in the Software without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
# sell copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
# IN THE SOFTWARE.
###############################################################################
---
name: S840D RunMyScreens
file_extensions:
  - com
scope: source.s840d_hmi

###############################################################################

variables:
  softkey: \b(?i:[HV]S[1-8]|RECALL)\b

###############################################################################
# MAIN CONTEXT
###############################################################################

contexts:

  main:
    - include: comment

    # archive header pragma is invalid in this context
    - match: '%\w+'
      scope: invalid.illegal.s840d_hmi

    # file contains EasyScreen/RunMyScreens
    - match: (?=//[ABGMS]\b)
      push:
        - include: comment
        - include: class-dialog
        - include: class-menu
        - include: class-array
        - include: class-block
        - include: class-grid
        # required for embedding in s840d_arc
        - match: (?=%)
          pop: true

    # file contains list of strings
    - match: (?=\d{1,6}\s+[01]\s+[01]\s+\".*?\")
      push:
        - meta_content_scope: meta.stringlist.s840d_hmi
        - include: comment
        - match: \b\d+\b
          scope: support.variable.textid.s840d_hmi
          push:
            - match: \b\d\b
              scope: comment.block.s840d_hmi
            - include: string
            - include: line-end
        # required for embedding in s840d_arc
        - match: (?=%)
          pop: true

###############################################################################
# ARRAY
#   top-level entity
#
#   //A(NAME)
#     (col1 / col2 / ...)
#     (col1 / col2 / ...)
#      ...
#   //END
###############################################################################

  class-array:
    - match: (//[Aa]\b)\s*(?=\()
      captures:
        0: meta.class.array.s840d_hmi
        1: keyword.class.begin.s840d_hmi
      push:
        - meta_content_scope: meta.class.array.parameters.s840d_hmi
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set:
            - meta_content_scope: meta.class.array.parameters.name.s840d_hmi
            - match: \)|$
              scope: punctuation.section.parameters.end.s840d_hmi
              set: class-array-body
            - include: class-name
        - include: illegal-pop

  class-array-body:
    - meta_content_scope: meta.class.array.body.s840d_hmi
    - match: (?=//)
      set:
        - meta_scope: meta.class.array.end.s840d_hmi
        - include: class-end-pop
    - match: \(
      scope: punctuation.section.row.begin.s840d_hmi
      push:
        - meta_scope: meta.row.s840d_hmi
        - match: \)|$
          scope: punctuation.section.row.end.s840d_hmi
          pop: true
        - match: /
          scope: punctuation.separator.column.s840d_hmi
        - include: string
        - include: number
        - include: boolean
        - include: illegal
    - include: comment
    - include: illegal

###############################################################################
# BLOCK
#   top-level entity
#
#   //B(NAME)
#   ...
#   //END
###############################################################################

  class-block:
    - match: (//[Bb]\b)\s*(?=\()
      captures:
        0: meta.class.subprogram.s840d_hmi
        1: keyword.class.begin.s840d_hmi
      push:
        - meta_content_scope: meta.class.subprogram.parameters.s840d_hmi
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set:
            - meta_content_scope: meta.class.subprogram.parameters.name.s840d_hmi
            - match: \)|$
              scope: punctuation.section.parameters.end.s840d_hmi
              set: class-block-body
            - include: class-name
        - include: illegal-pop

  class-block-body:
    - meta_content_scope: meta.class.subprogram.body.s840d_hmi
    - match: (?=//)
      set:
        - meta_scope: meta.class.subprogram.end.s840d_hmi
        - include: class-end-pop
    - include: def-method-sub
    - include: comment
    - include: illegal

###############################################################################
# GRID
#   top-level entity
#
#   A column definition is wideley equal to a normal variable definition and
#   requires the following entries.
#   (type/min,max//description,column title/attribute/picture/
#    variable/column width/Offset1, Offset2, Offset3)
#
#   //G(NAME/TYPE/ROWCOUNT/FIXED ROW/FIXED COL)
#   (../../..)  ; column 1
#   (../../..)  ; column 2
#   ...
#   //END
###############################################################################

  class-grid:
    - match: (//[Gg]\b)\s*(?=\()
      captures:
        0: meta.class.grid.s840d_hmi
        1: keyword.class.begin.s840d_hmi
      push:
        - meta_content_scope: meta.class.grid.parameters.s840d_hmi
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set: class-grid-attr-name
        - include: class-grid-attr-end

  class-grid-attr-name:
    - meta_content_scope: meta.class.grid.parameters.name.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-grid-attr-type
    - include: class-name
    - include: class-grid-attr-end

  class-grid-attr-type:
    - meta_content_scope: meta.class.grid.parameters.type.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-grid-attr-rowcount
    - include: number
    - include: class-grid-attr-end

  class-grid-attr-rowcount:
    - meta_content_scope: meta.class.grid.parameters.row.count.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-grid-attr-fixed-row
    - include: number
    - include: class-grid-attr-end

  class-grid-attr-fixed-row:
    - meta_content_scope: meta.class.grid.parameters.row.fixed.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-grid-attr-fixed-col
    - match: '[01]'
      scope: constant.numeric.integer.s840d_hmi
    - include: boolean
    - include: class-grid-attr-end

  class-grid-attr-fixed-col:
    - meta_content_scope: meta.class.grid.parameters.col.fixed.s840d_hmi
    - match: '[01]'
      scope: constant.numeric.integer.s840d_hmi
    - include: boolean
    - include: class-grid-attr-end

  class-grid-attr-end:
    - match: \)|$
      scope: punctuation.section.parameters.end.s840d_hmi
      set: class-grid-body
    - include: illegal

  class-grid-body:
    - meta_content_scope: meta.class.grid.body.s840d_hmi
    - match: (?=//)
      set:
        - meta_scope: meta.class.grid.end.s840d_hmi
        - include: class-end-pop
    - include: def-column
    - include: comment
    - include: illegal

###############################################################################
# GRID COLUMN
#   second-level entity
#   exists only in grid
#
#   A column definition is wideley equal to a normal variable definition and
#   requires the following entries.
#   (type/min,max//description,column title/attribute/picture/
#    variable/column width/Offset1, Offset2, Offset3)
#
###############################################################################

  def-column:
    - match: \(
      scope: meta.column.s840d_hmi punctuation.section.column.begin.s840d_hmi
      push: def-column-type

  def-column-type:
    - meta_content_scope: meta.column.type.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-limits
    - include: storage-type
    - include: def-column-end

  def-column-limits:
    - meta_content_scope: meta.column.limits.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-default
    - include: attr-seperator
    - include: number
    - include: def-column-end

  def-column-default:
    - meta_content_scope: meta.column.default.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-captions
    - include: string
    - include: number
    - include: def-column-end

  # texts (tooltip, title)
  def-column-captions:
    - meta_content_scope: meta.column.captions.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-attributes
    - include: attr-seperator
    - include: string
    - include: def-column-end

  def-column-attributes:
    - meta_content_scope: meta.column.attributes.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-picture
    - include: attr-seperator
    - include: attribute-accesslevel
    - include: attribute-limit
    - include: attribute-writeability
    - include: def-column-end

  def-column-picture:
    - meta_content_scope: meta.column.picture.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-address
    - include: string
    - include: def-column-end

  def-column-address:
    - meta_content_scope: meta.column.address.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-width
    - include: string
    - include: def-column-end

  def-column-width:
    - meta_content_scope: meta.column.width.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-column-offsets
    - include: number
    - include: def-column-end

  def-column-offsets:
    - meta_content_scope: meta.column.offsets.s840d_hmi
    - include: attr-seperator
    - include: number
    - include: def-column-end

  def-column-end:
    - match: \)|$
      scope: punctuation.section.column.end.s840d_hmi
      pop: true
    - include: illegal

###############################################################################
# DIALOG
#   top-level entity
#
#   //M(MSK_NAME/"Caption"/"\\pic.png"/0,0,640,480/"MB0"/20,20,80,80/AC4)
#   ...
#   //END
###############################################################################

  class-dialog:
    - match: (//[Mm]\b)\s*(?=\()
      captures:
        0: meta.class.dialog.s840d_hmi
        1: keyword.class.begin.s840d_hmi
      push:
        - meta_content_scope: meta.class.dialog.parameters.s840d_hmi
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set: class-dialog-attr-name
        - include: class-dialog-attr-end

  class-dialog-attr-name:
    - meta_content_scope: meta.class.dialog.parameters.name.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-caption
    - include: class-name
    - include: class-dialog-attr-end

  class-dialog-attr-caption:
    - meta_content_scope: meta.class.dialog.parameters.caption.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-picture
    - include: string
    - include: class-dialog-attr-end

  class-dialog-attr-picture:
    - meta_content_scope: meta.class.dialog.parameters.picture.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-dimension
    - include: string
    - include: class-dialog-attr-end

  class-dialog-attr-dimension:
    - meta_content_scope: meta.class.dialog.parameters.dimension.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-variable
    - include: attr-seperator
    - include: number
    - include: class-dialog-attr-end

  class-dialog-attr-variable:
    - meta_content_scope: meta.class.dialog.parameters.variable.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-picture-position
    - include: string
    - include: class-dialog-attr-end

  class-dialog-attr-picture-position:
    - meta_content_scope: meta.class.dialog.parameters.picture-position.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-attribute
    - include: attr-seperator
    - include: number
    - include: class-dialog-attr-end

  class-dialog-attr-attribute:
    - meta_content_scope: meta.class.dialog.parameters.attributes.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: class-dialog-attr-end
    - include: attr-seperator
    - include: attribute-accesslevel
    - include: attribute-alignment
    - include: attribute-alignment-title
    - include: attribute-changeblock
    - include: attribute-column-mode
    - include: attribute-fontsize
    - include: attribute-scaling-fields
    - include: attribute-scaling-fields-touch
    - include: attribute-scaling-pictures
    - include: attribute-scolling
    - include: attribute-writeability
    - include: attribute-x3d
    - include: class-dialog-attr-end

  class-dialog-attr-end:
    - match: \)|$
      scope: punctuation.section.parameters.end.s840d_hmi
      set: class-dialog-body
    - include: illegal

  class-dialog-body:
    - meta_content_scope: meta.class.dialog.body.s840d_hmi
    - match: (?=//)
      set:
        - meta_scope: meta.class.dialog.end.s840d_hmi
        - include: class-end-pop
    - include: def-operand
    - include: def-softkey
    - include: def-methods
    - include: comment
    - include: illegal

###############################################################################
# SOFTKEY BAR
#   top-level entity
#
#   //S(SK_NAME)
#   ...
#   //END
###############################################################################

  class-menu:
    - match: (//[Ss]\b)\s*(?=\()
      captures:
        0: meta.class.menu.s840d_hmi
        1: keyword.class.begin.s840d_hmi
      push:
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set:
            - meta_scope: meta.class.menu.parameters.name.s840d_hmi
            - match: \)|$
              scope: punctuation.section.parameters.end.s840d_hmi
              set: class-menu-body
            - include: class-name
        - include: class-menu-body

  class-menu-body:
    - meta_content_scope: meta.class.menu.body.s840d_hmi
    - match: (?=//)
      set:
        - meta_scope: meta.class.menu.end.s840d_hmi
        - include: class-end-pop
    - include: def-softkey
    - include: def-methods
    - include: comment
    - include: illegal

###############################################################################
# SECTION prototypes
###############################################################################

  class-name:
    - match: \b\w+\b
      scope: entity.name.class.s840d_hmi

  attr-seperator:
    - match: ','
      scope: punctuation.separator.s840d_hmi

  class-end-pop:
    - match: //(?i:END)\b
      scope: keyword.class.end.s840d_hmi
      pop: true
    - include: illegal

###############################################################################
# INPUT / OPERAND
#   second-level entity
#   exists only in dialog
#
#   DEF VAR=(TYP/MIN,MAX/DFLT/"","","",""/ATTR/VAR//CAPTIONPOS/INPUTPOS/COLOR)
###############################################################################

  def-operand:
    - match: \b(?i:DEF)\b
      scope: keyword.language.def.s840d_hmi
      push: def-operand-name

  def-operand-name:
    - meta_scope: meta.definition.operand.s840d_hmi
    - include: comment
    - match: \b\w+\b
      scope: variable.other.s840d_hmi
      set: def-operand-arraysize

  def-operand-arraysize:
    - match: \(
      scope: punctuation.section.parameters.begin.s840d_hmi
      set:
        - meta_scope: meta.definition.operand.array-size.s840d_hmi
        - match: \)
          scope: punctuation.section.parameters.end.s840d_hmi
          set: def-operand-assign
        - include: number
        - include: line-end
    - match: (?=\S)
      set: def-operand-assign

  def-operand-assign:
    - match: (=)\s*(?=\()
      captures:
        0: meta.definition.operand.s840d_hmi
        1: keyword.operator.assignment.s840d_hmi
      set:
        - match: \(
          scope: meta.definition.operand.parameters.s840d_hmi punctuation.section.parameters.begin.s840d_hmi
          set: def-operand-type
        - include: def-operand-seperator
    - include: def-operand-seperator

  def-operand-type:
    - meta_content_scope: meta.definition.operand.parameters.type.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-limits
    - include: storage-type
    - include: def-operand-end

  def-operand-limits:
    - meta_content_scope: meta.definition.operand.parameters.limits.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-default
    - match: '%\w+'
      scope: entity.name.grid.s840d_hmi
    - include: attr-seperator
    - include: string
    - include: number
    - include: operator
    - include: def-operand-end

  def-operand-default:
    - meta_content_scope: meta.definition.operand.parameters.default.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-captions
    - include: string
    - include: number
    - include: def-operand-end

  # texts (description, caption/picture, shortcut, unit)
  def-operand-captions:
    - meta_content_scope: meta.definition.operand.parameters.captions.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-attributes
    - include: attr-seperator
    - include: string
    - include: def-operand-end

  def-operand-attributes:
    - meta_content_scope: meta.definition.operand.parameters.attributes.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-picture
    - include: attr-seperator
    - include: attribute-accesslevel
    - include: attribute-alignment
    - include: attribute-changeblock
    - include: attribute-display-mode
    - include: attribute-fontsize
    - include: attribute-limit
    - include: attribute-toggle-symbol
    - include: attribute-update-rate
    - include: attribute-writeability
    - include: def-operand-end

  def-operand-picture:
    - meta_content_scope: meta.definition.operand.parameters.picture.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-address
    - include: string
    - include: def-operand-end

  def-operand-address:
    - meta_content_scope: meta.definition.operand.parameters.address.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-captionpos
    - include: string
    - include: def-operand-end

  # caption position (left, top, width, height)
  def-operand-captionpos:
    - meta_content_scope: meta.definition.operand.parameters.position.caption.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-inputpos
    - include: attr-seperator
    - include: number
    - include: def-operand-end

  # input control position (left, top, width, height)
  def-operand-inputpos:
    - meta_content_scope: meta.definition.operand.parameters.position.input.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-colors
    - include: attr-seperator
    - include: number
    - include: def-operand-end

  def-operand-colors:
    - meta_content_scope: meta.definition.operand.parameters.colors.s840d_hmi
    - match: /
      scope: punctuation.separator.s840d_hmi
      set: def-operand-helpfile
    - include: attr-seperator
    - include: number
    - include: def-operand-end

  def-operand-helpfile:
    - meta_content_scope: meta.definition.operand.parameters.helpfile.s840d_hmi
    - include: attr-seperator
    - include: number
    - include: string
    - include: def-operand-end

  def-operand-end:
    - match: \)
      scope: punctuation.section.parameters.end.s840d_hmi
      set: def-operand-seperator
    - include: line-end

  def-operand-seperator:
    - match: ','
      scope: punctuation.separator.s840d_hmi
      set: def-operand-name
    - include: line-end

###############################################################################
# SOFTKEY DEFINITION
#   second-level entity
#   exists in dialog and menu
#
#   HS1=("Caption",AC1,SE2)
###############################################################################

  def-softkey:
    - match: '{{softkey}}'
      scope: entity.name.softkey.s840d_hmi
      push:
        - meta_scope: meta.definition.softkey.s840d_hmi
        - match: =
          scope: keyword.operator.assignment.s840d_hmi
          set: def-softkey-attr
        - include: line-end

  def-softkey-attr:
    - meta_content_scope: meta.definition.softkey.s840d_hmi
    - match: \(
      scope: punctuation.section.parameters.begin.s840d_hmi
      set: def-softkey-attr-caption
    - include: line-end

  def-softkey-attr-caption:
    - meta_content_scope: meta.definition.softkey.caption.s840d_hmi
    - match: ','
      scope: punctuation.separator.s840d_hmi
      set: def-softkey-attr-attributes
    - match: \[
      scope: punctuation.section.caption-group.begin.s840d_hmi
      push:
        - meta_scope: meta.caption-group.s840d_hmi
        - match: \]
          scope: punctuation.section.caption-group.end.s840d_hmi
          pop: true
        - include: expressions
    - include: string
    - include: def-softkey-end

  def-softkey-attr-attributes:
    - meta_content_scope: meta.definition.softkey.attributes.s840d_hmi
    - match: ','
      scope: punctuation.separator.s840d_hmi
    - include: attribute-accesslevel
    - include: attribute-alignment-picture
    - include: attribute-alignment-text
    - include: attribute-state
    - include: def-softkey-end

  def-softkey-end:
    - match: \)|$
      scope: punctuation.section.parameters.end.s840d_hmi
      pop: true
    - include: illegal

###############################################################################
# class methods
#   second-level entities
###############################################################################

  def-methods:
    - include: def-method-activate
    - include: def-method-change
    - include: def-method-focus
    - include: def-method-load
    - include: def-method-output
    - include: def-method-press
    - include: def-method-sub
    - include: def-method-unload

###############################################################################
# ACTIVATE block
#   second-level entity
#   exists in dialog and menu
#
#   ACTIVATE
#   ....
#   END_ACTIVATE
###############################################################################

  def-method-activate:
    - match: \b(?i:ACTIVATE)\b
      scope: keyword.definition.method.begin.s840d_hmi
      push: def-method-activate-body

  def-method-activate-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_ACTIVATE)\b
      scope: keyword.definition.method.end.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# CHANGE block
#   second-level entity
#   exists in dialog and menu
#
#   CHANGE(operand)
#   ....
#   END_CHANGE
###############################################################################

  def-method-change:
    - match: \b(?i:CHANGE)\b
      scope: keyword.definition.method.change.s840d_hmi
      push:
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set:
            - meta_scope: meta.parameters.s840d_hmi
            - match: \)|$
              scope: punctuation.section.parameters.end.s840d_hmi
              set: def-method-change-body
            - include: operand
            - include: illegal
        - include: def-method-change-body

  def-method-change-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_CHANGE)\b
      scope: keyword.definition.method.end_change.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# FOCUS block
#   second-level entity
#   exists in dialog and menu
#
#   FOCUS
#   ....
#   END_FOCUS
###############################################################################

  def-method-focus:
    - match: \b(?i:FOCUS)\b
      scope: keyword.definition.method.focus.s840d_hmi
      push: def-method-focus-body

  def-method-focus-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_FOCUS)\b
      scope: keyword.definition.method.end_focus.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# LOAD block
#   second-level entity
#   exists in dialog and menu
#
#   LOAD
#   ....
#   END_LOAD
###############################################################################

  def-method-load:
    - match: \b(?i:LOAD)\b
      scope: keyword.definition.method.load.s840d_hmi
      push: def-method-load-body

  def-method-load-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_LOAD)\b
      scope: keyword.definition.method.end_load.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# UNLOAD block
#   second-level entity
#   exists in dialog and menu
#
#   UNLOAD
#   ....
#   END_UNLOAD
###############################################################################

  def-method-unload:
    - match: \b(?i:UNLOAD)\b
      scope: keyword.definition.method.unload.s840d_hmi
      push: def-method-unload-body

  def-method-unload-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_UNLOAD)\b
      scope: keyword.definition.method.end_unload.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# OUTPUT block
#   second-level entity
#   exists in dialog and menu
#
#   OUTPUT(operand)
#   ....
#   END_CHANGE
###############################################################################

  def-method-output:
    - match: \b(?i:OUTPUT)\b
      scope: keyword.definition.method.output.s840d_hmi
      push: def-method-output-argument

  def-method-output-argument:
    - match: \(
      scope: punctuation.section.parameters.begin.s840d_hmi
      set: def-method-output-argument-name
    - include: line-end

  def-method-output-argument-name:
    - meta_scope: meta.parameters.name.s840d_hmi
    - match: ','
      scope: punctuation.separator.s840d_hmi
      set: def-method-output-argument-version
    - include: operand
    - include: def-method-output-argument-end

  def-method-output-argument-version:
    - meta_content_scope: meta.parameters.version.s840d_hmi
    - include: number
    - include: def-method-output-argument-end

  def-method-output-argument-end:
    - match: \)|$
      scope: punctuation.section.parameters.end.s840d_hmi
      set: def-method-output-body
    - include: illegal

  def-method-output-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_OUTPUT)\b
      scope: keyword.definition.method.end_output.s840d_hmi
      pop: true
    # register not allowed in output
    - match: \b(?i:REG)\b
      scope: invalid.illegal.s840d_hmi
    - include: expressions

###############################################################################
# PRESS block
#   second-level entity
#   exists in dialog and menu
#
#   PRESS(HSx)
#   ....
#   END_PRESS
###############################################################################

  def-method-press:
    - match: \b(?i:PRESS)\b
      scope: keyword.definition.method.press.s840d_hmi
      push:
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set:
            - meta_scope: meta.method.parameters.s840d_hmi
            - match: \)|$
              scope: punctuation.section.parameters.end.s840d_hmi
              set: def-method-press-body
            - match: '{{softkey}}'
              scope: entity.name.softkey.s840d_hmi
            - match: \b(?i:P[UD]|S[LRUD])\b
              scope: entity.name.key.s840d_hmi
            - include: illegal
        - include: line-end

  def-method-press-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_PRESS)\b
      scope: keyword.definition.method.end_press.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# SUB block
#   second-level entity
#   exists in dialog and menu
#
#   SUB("function_name")
#   ....
#   END_SUB
###############################################################################

  def-method-sub:
    - match: \b(?i:SUB)\b
      scope: keyword.definition.method.sub.s840d_hmi
      push:
        - match: \(
          scope: punctuation.section.parameters.begin.s840d_hmi
          set:
            - meta_scope: meta.method.parameters.s840d_hmi
            - match: \)|$
              scope: punctuation.section.parameters.end.s840d_hmi
              set: def-method-sub-body
            - include: operand
            - include: illegal
        - include: def-method-sub-body

  def-method-sub-body:
    - meta_content_scope: meta.block.method.s840d_hmi
    - match: \b(?i:END_SUB)\b
      scope: keyword.definition.method.end_sub.s840d_hmi
      pop: true
    - include: statements

###############################################################################
# STATEMENTS
#   third-level entities
#   exist within event-handler and sub-routine
###############################################################################

  statements:
    - include: comment
    - include: conditional
    - include: procedures
    - include: expressions

  comment:
    - match: ';.*$'
      scope: comment.line.s840d_hmi

  conditional:
    - match: \b(?i:IF|ELSE|ENDIF)\b
      scope: keyword.operator.conditional.s840d_hmi

  procedures:
    - match: \b(?i:EXIT(?:LS)?|RETURN)\b
      scope: support.function.s840d_hmi
      push: function-arguments

    - match: \b(?i:CALL|[CDEM]P|DLGL|GC|L[ABGMS]|LINE|RECT|M?[RW]NP|S[BFP])\b
      scope: support.function.s840d_hmi
      push: function-arguments

###############################################################################

  expressions:
    - include: string       # must be the first
    - include: boolean
    - include: number
    - include: attr-seperator
    - include: attribute-accesslevel
    - include: attribute-alignment
    - include: attribute-alignment-title
    - include: attribute-changeblock
    - include: attribute-column-mode
    - include: attribute-display-mode
    - include: attribute-fontsize
    - include: attribute-limit
    - include: attribute-scaling-fields
    - include: attribute-scaling-fields-touch
    - include: attribute-scaling-pictures
    - include: attribute-scolling
    - include: attribute-state
    - include: attribute-toggle-symbol
    - include: attribute-update-rate
    - include: attribute-writeability
    - include: attribute-x3d
    - include: operator
    - include: function
    - include: group        # must follow after function
    - include: softkey
    - include: variable
    - include: operand
    - include: placeholder

  # is used for snippet parameters
  placeholder:
    - match: \{
      scope: punctuation.section.group.begin.s840d_hmi
      push:
        - meta_scope: invalid.illegal.s840d_hmi
        - match: \}
          scope: punctuation.section.group.end.s840d_hmi
          pop: true
    - match: \}
      scope: invalid.illegal.s840d_hmi

  attribute-accesslevel:
    # attribute AC.sublime-completions
    - match: \b[Aa][Cc][0-7]\b
      scope: constant.language.attribute.accesslevel.s840d_hmi

  attribute-alignment:
    # attribute AL.sublime-completions
    - match: \b[Aa][Ll][0-2]\b
      scope: constant.language.attribute.alignment.s840d_hmi

  attribute-alignment-picture:
    # Softkey picture alignment
    # 0: left
    # 1: right
    # 2: centered
    # 3: top (default)
    # 4: bottom
    - match: \b[Pp][Aa][0-4]\b
      scope: constant.language.attribute.alignment.picture.s840d_hmi

  attribute-alignment-text:
    # Softkey text alignment
    # 0: text is not aligned to picture
    # 1: text is aligned to picture (default)
    # attribute TP.sublime-completions
    - match: \b[Tt][Pp][0-1]\b
      scope: constant.language.attribute.alignment.text.s840d_hmi

  attribute-alignment-title:
    # title picture alignment
    # 0: default
    # 1: align title right next to a picture
    # attribute PG.sublime-completions
    - match: \b[Pp][Gg][01]\b
      scope: constant.language.attribute.alignment.title.s840d_hmi

  attribute-changeblock:
    # attribute CB.sublime-completions
    - match: \b[Cc][Bb][01]\b
      scope: constant.language.attribute.changeblock.s840d_hmi

  attribute-column-mode:
    # attribute CM.sublime-completions
    - match: \b[Cc][Mm][01]\b
      scope: constant.language.attribute.column-mode.s840d_hmi

  attribute-display-mode:
    # operand display mode
    # 0: default intput field
    # 1: single color progress bar
    # 2: multi color progress bar
    # attribute DT.sublime-completions
    - match: \b[Dd][Tt][012]\b
      scope: constant.language.attribute.display-mode.s840d_hmi

  attribute-fontsize:
    # attribute FS.sublime-completions
    - match: \b[Ff][Ss][12]\b
      scope: constant.language.attribute.fontsize.s840d_hmi

  attribute-limit:
    # attribute LI.sublime-completions
    - match: \b[Ll][Ii][0-3]\b
      scope: constant.language.attribute.limit.s840d_hmi

  attribute-scaling-fields:
    # Field scaling
    # 0: legacy (640x480)
    # 1: proportional scaling of height and row distance
    # 2: as 1 but with scaling of width and column position
    # attribute FA.sublime-completions
    - match: \b[Ff][Aa][012]\b
      scope: constant.language.attribute.scaling.fields.s840d_hmi

  attribute-scaling-fields-touch:
    # automatic height adjustment of fields with touch enabled
    # 0: disabled
    # 1: adjust height of fields without size attributes
    # 2: adjust height of all fields
    # attribute MA.sublime-completions
    - match: \b[Mm][Aa][012]\b
      scope: constant.language.attribute.scaling.fields.touch.s840d_hmi

  attribute-scaling-pictures:
    # Picture scaling
    # 0: legacy (640x480)
    # 1: optimized (pixel accurate)
    # attribute PA.sublime-completions
    - match: \b[Pp][Aa][01]\b
      scope: constant.language.attribute.scaling.pictures.s840d_hmi

  attribute-scolling:
    # free scrolling
    # 0: disabled
    # 1: active (default)
    # attribute KM.sublime-completions
    - match: \b[Kk][Mm][01]\b
      scope: constant.language.attribute.scrolling.s840d_hmi

  attribute-state:
    # se1: visible (default)
    # se2: disabled (grey font)
    # se3: highlighted (most recently activated Softkey)
    # attribute SE.sublime-completions
    - match: \b[Ss][Ee][0-3]\b
      scope: constant.language.attribute.state.s840d_hmi

  attribute-toggle-symbol:
    # toggle symbol
    # 0: hide (default)
    # 1: show
    # attribute TG.sublime-completions
    - match: \b[Tt][Gg][01]\b
      scope: constant.language.attribute.toggle-symbol.s840d_hmi

  attribute-update-rate:
    # attribute UR.sublime-completions
    - match: \b[Uu][Rr][0-8]\b
      scope: constant.language.attribute.update-rate.s840d_hmi

  attribute-writeability:
    # attribute WR.sublime-completions
    - match: \b[Ww][Rr][0-5]\b
      scope: constant.language.attribute.writeability.s840d_hmi

  attribute-x3d:
    # attribute XG.sublime-completions
    - match: \b[Xx][Gg][01]\b
      scope: constant.language.attribute.x3d.s840d_hmi

  boolean:
    - match: \b(?i:TRUE|FALSE)\b
      scope: constant.language.boolean.s840d_hmi

  function:
    - match: \b(?i:A(?:BS|COS|SIN|TAN)|COS|ROUND|S(?:DEG|IN|RAD|QRT)|TAN)\b
      scope: support.function.arithmetic.s840d_hmi
      push: function-arguments
    - match: \b(?i:IS(?:NUM|STR)|CVAR|EVAL)\b
      scope: support.function.checks.s840d_hmi
      push: function-arguments
    - match: \b(?i:INSTR|LEN|LEFT|MIDS|REPLACE|RIGHT)\b
      scope: support.function.string.s840d_hmi
      push: function-arguments
    - match: \b(?i:PI_(?:SERVICE|START))\b
      scope: support.function.other.s840d_hmi
      push: function-arguments

  function-arguments:
    - meta_scope: meta.function-call.s840d_hmi
    - match: (?=\()
      set:
        - match: \(
          scope: punctuation.section.arguments.begin.s840d_hmi
          set:
            - meta_scope: meta.function-call.arguments.s840d_hmi
            - match: \)
              scope: punctuation.section.arguments.end.s840d_hmi
              pop: true
            - match: ','
              scope: punctuation.separator.s840d_hmi
            - include: expressions
            - include: illegal
    - match: (?=\S)
      pop: true

  group:
    - match: \(
      scope: punctuation.section.group.begin.s840d_hmi
      push:
        - meta_scope: meta.group.s840d_hmi
        - match: \)
          scope: punctuation.section.group.end.s840d_hmi
          pop: true
        - include: expressions
        - include: illegal
    - match: \)
      scope: invalid.illegal.s840d_hmi

  number:
    - match: \b(?i:PI)\b
      scope: constant.language.s840d_hmi
    - match: \b[1-8](\.\d+)?EX[-+]?\d{1,2}\b
      scope: constant.numeric.float.s840d_hmi
    - match: \b\d+\.\d+\b
      scope: constant.numeric.float.s840d_hmi
    - match: \b\d+\b
      scope: constant.numeric.integer.s840d_hmi
    - match: \b[Bb][01]+\b
      scope: constant.numeric.binary.s840d_hmi
    - match: \b[Hh]\h+\b
      scope: constant.numeric.hexadecimal.s840d_hmi

  operator:
    - match: =(?!=)
      scope: keyword.operator.assignment.s840d_hmi
    - match: <<
      scope: keyword.operator.assignment.s840d_hmi
    - match: <>|==|>=|<=|<|>
      scope: keyword.operator.relational.s840d_hmi
    - match: '[-+/\*]'
      scope: keyword.operator.arithmetic.s840d_hmi
    - match: \b(?i:MOD)\b
      scope: keyword.operator.arithmetic.s840d_hmi
    - match: \b(?i:AND|OR|NOT)\b
      scope: keyword.operator.boolean.s840d_hmi
    - match: \b(?i:B(?:AND|X?OR|NOT)|SH[LR])\b
      scope: keyword.operator.binary.s840d_hmi

  operand:
    - match: \b\w+\b
      scope: variable.other.s840d_hmi
      push: operand-index

  softkey:
    - match: '{{softkey}}'
      scope: entity.name.softkey.s840d_hmi
      push:
        - match: \.
          scope: punctuation.accessor.s840d_hmi
          set:
            # list of valid attributes
            - match: \b(?i:ac|s[te])\b
              scope: entity.other.attribute-name.s840d_hmi
              pop: true
            - include: illegal-pop
        - match: (?=\S)
          pop: true

  storage-type:
    - match: \b(?i:[CBV]|I[BDH]?(?:[BWD]U?)?|R\d*|S\d*)\b
      scope: storage.type.s840d_hmi

  string:
    - match: '"'
      scope: punctuation.definition.string.begin.s840d_hmi
      push:
        - meta_scope: string.quoted.double.s840d_hmi
        - match: '"'
          scope: punctuation.definition.string.end.s840d_hmi
          pop: true
        - match: \'"\'
          scope: constant.character.escape.quoted.double.s840d_hmi
        - match: \'
          scope: constant.character.escape.quoted.single.s840d_hmi
        - match: '%[Nn]'
          scope: constant.other.linefeed.s840d_hmi
    - match: \$\d+\b
      scope: support.variable.textid.s840d_hmi

  variable:
    - match: \b(?i:CUR(?:POS|VER)|ENTRY|ERR|FILE_ERR|FOC|S_CHAN)\b
      scope: support.variable.language.s840d_hmi
    - match: \b(?i:REG)\b
      scope: support.variable.register.s840d_hmi
      push: operand-index

###############################################################################

  line-end:
    - match: $
      pop: true
    - include: comment
    - include: illegal

  illegal:
    - match: \S+?(?=[/,])
      scope: invalid.illegal.s840d_hmi

  illegal-pop:
    - match: \S+
      scope: invalid.illegal.s840d_hmi
      pop: true

###############################################################################
# OBJECT MEMBERS
###############################################################################

  operand-index:
    - match: \[
      scope: punctuation.section.item-access.begin.s840d_hmi
      set:
        - meta_scope: meta.item-access.s840d_hmi
        - match: \]
          scope: punctuation.section.item-access.end.s840d_hmi
          set: operand-members
        - include: expressions
    - include: operand-members

  operand-members:
    - match: \.
      scope: punctuation.accessor.parameters.s840d_hmi
      set:
        # list of valid attributes
        - match: \b(?i:a[cl]|bc|cb|f[cs]|gt|hlp|l[it]|m(?:ax|in)|[su]t|typ|v(?:a[lr]|ld)|wr)\b
          scope: entity.other.attribute-name.s840d_hmi
          pop: true
        - include: illegal-pop
    - match: (?=\S)
      pop: true
